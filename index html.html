<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Projekt Nemo</title>
    <style>
      *,
      *:before,
      *:after {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, Helvetica, sans-serif;
        background: #327686;
        color: #efefef;
        font-size: 16px;
        margin: 0;
        padding: 8px;
      }

      h2 {
        font-size: 18px;
      }

      section.main {
        display: flex;
        flex-direction: column;
      }

      #menu {
        display: none;
        flex-wrap: nowrap;
        width: 100%;
        max-width: 500px;
        background: #363636;
        padding: 8px;
        border-radius: 4px;
        margin-top: 10px;
        margin-right: 0;
      }

      #content {
        display: flex;
        flex-wrap: wrap;
        align-items: stretch;
      }

      figure {
        padding: 0;
        margin: 0;
        width: 100%;
      }

      figure img {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 4px;
        margin-top: 8px;
      }

      @media (min-width: 800px) and (orientation: landscape) {
        #content {
          flex-wrap: nowrap;
        }
        #menu {
          margin-right: 10px;
          min-width: 340px;
        }
        figure img {
          max-width: 100%;
          max-height: calc(100vh - 40px);
          width: auto;
        }
      }

      section#buttons {
        display: flex;
        flex-wrap: nowrap;
        justify-content: space-between;
      }

      #nav-toggle {
        cursor: pointer;
        display: block;
        background: #363636;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 5px;
      }

      #nav-toggle-cb {
        outline: 0;
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
      }

      #nav-toggle-cb:checked + #menu {
        display: flex;
        flex-direction: column;
      }

      .input-group {
        display: flex;
        flex-wrap: nowrap;
        line-height: 22px;
        margin: 8px 0;
        align-items: center;
      }

      .input-group > label {
        display: inline-block;
        padding-right: 10px;
        min-width: 40%;
      }

      .input-group input,
      .input-group select {
        flex-grow: 1;
      }

      .range-max,
      .range-min {
        display: inline-block;
        padding: 0 5px;
        font-size: 14px;
      }

      button,
      .button {
        display: block;
        margin: 5px;
        padding: 0 12px;
        border: 0;
        line-height: 28px;
        cursor: pointer;
        color: #fff;
        background: #ff3034;
        border-radius: 5px;
        font-size: 16px;
        outline: 0;
        width: 100%;
      }

      section#buttons button {
        width: 48%;
      }

      .save {
        position: absolute;
        right: 25px;
        top: 10px;
        height: auto;
        line-height: 20px;
        padding: 4px 8px;
        text-decoration: none;
        cursor: pointer;
        width: auto;
      }

      button:hover {
        background: #ff494d;
      }

      button:active {
        background: #f21c21;
      }

      button.disabled {
        cursor: default;
        background: #a0a0a0;
      }

      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 22px;
        background: #363636;
        cursor: pointer;
        margin: 0;
      }

      input[type="range"]:focus {
        outline: 0;
      }

      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 2px;
        cursor: pointer;
        background: #efefef;
        border-radius: 0;
        border: 0 solid #efefef;
      }

      input[type="range"]::-webkit-slider-thumb {
        border: 1px solid rgba(0, 0, 30, 0);
        height: 22px;
        width: 22px;
        border-radius: 50px;
        background: #ff3034;
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -11.5px;
      }

      .switch {
        display: block;
        position: relative;
        line-height: 22px;
        font-size: 16px;
        height: 22px;
      }

      .switch input {
        outline: 0;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        width: 50px;
        height: 22px;
        border-radius: 22px;
        cursor: pointer;
        background-color: grey;
      }

      .slider,
      .slider:before {
        display: inline-block;
        transition: 0.4s;
      }

      .slider:before {
        position: relative;
        content: "";
        border-radius: 50%;
        height: 16px;
        width: 16px;
        left: 4px;
        top: 3px;
        background-color: #fff;
      }

      input:checked + .slider {
        background-color: #ff3034;
      }

      input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        transform: translateX(26px);
      }

      select {
        border: 1px solid #363636;
        font-size: 14px;
        height: 30px;
        outline: 0;
        border-radius: 5px;
        width: 100%;
        background: #fff;
        color: #333;
      }

      .image-container {
        position: relative;
        min-width: 160px;
        width: 100%;
      }

      .close {
        position: absolute;
        right: 5px;
        top: 5px;
        background: #ff3034;
        width: 24px;
        height: 24px;
        border-radius: 100px;
        color: #fff;
        text-align: center;
        line-height: 24px;
        cursor: pointer;
        font-weight: bold;
      }

      .hidden {
        display: none;
      }

      input[type="text"],
      input[type="number"] {
        border: 1px solid #363636;
        font-size: 14px;
        height: 30px;
        margin: 1px;
        outline: 0;
        border-radius: 5px;
        padding-left: 5px;
        width: 100%;
        color: #333;
      }

      .text {
        width: 100%;
      }

      .inline-button {
        line-height: 20px;
        margin: 2px;
        padding: 5px 10px;
      }

      @media (max-width: 600px) {
        .input-group > label {
          width: 100%;
          margin-bottom: 5px;
          font-weight: bold;
          color: #ccc;
        }

        .input-group input,
        .input-group select,
        .input-group .text {
          width: 100%;
        }

        #set-xclk-group .text {
          width: 70%;
        }
        #set-xclk-group button {
          width: 25%;
          margin-left: 5%;
        }

        .input-group:has(input[type="range"]) {
          flex-wrap: nowrap;
        }

        .input-group:has(input[type="range"]) {
          flex-wrap: wrap;
        }

        .range-min,
        .range-max {
          width: 10%;
          text-align: center;
        }
        input[type="range"] {
          width: 80%;
        }
      }
    </style>
  </head>
  <body>
    <section class="main">
      <div id="logo">
        <label for="nav-toggle-cb" id="nav-toggle"
          >&#9776;&nbsp;&nbsp;Ustawienia kamery</label
        >
      </div>
      <div id="content">
        <div id="sidebar">
          <input type="checkbox" id="nav-toggle-cb" checked="checked" />
          <nav id="menu">
            <section id="xclk-section" class="nothidden">
              <div class="input-group" id="set-xclk-group">
                <label for="set-xclk">XCLK MHz</label>
                <div class="text">
                  <input
                    id="xclk"
                    type="text"
                    minlength="1"
                    maxlength="2"
                    size="2"
                    value="20"
                  />
                </div>
                <button class="inline-button" id="set-xclk">Set</button>
              </div>
            </section>
            <div class="input-group" id="framesize-group">
              <label for="framesize">Resolution</label
              ><select id="framesize" class="default-action">
                <option value="13">UXGA(1600x1200)</option>
                <option value="12">SXGA(1280x1024)</option>
                <option value="11">HD(1280x720)</option>
                <option value="10">XGA(1024x768)</option>
                <option value="9">SVGA(800x600)</option>
                <option value="8">VGA(640x480)</option>
                <option value="7">HVGA(480x320)</option>
                <option value="6">CIF(400x296)</option>
                <option value="5">QVGA(320x240)</option>
                <option value="4">240x240</option>
                <option value="3">HQVGA(240x176)</option>
                <option value="2">QCIF(176x144)</option>
                <option value="1">QQVGA(160x120)</option>
                <option value="0">96x96</option>
              </select>
            </div>
            <div class="input-group" id="quality-group">
              <label for="quality">Quality</label>
              <div class="range-min">4</div>
              <input
                type="range"
                id="quality"
                min="4"
                max="63"
                value="10"
                class="default-action"
              />
              <div class="range-max">63</div>
            </div>
            <div class="input-group" id="brightness-group">
              <label for="brightness">Brightness</label>
              <div class="range-min">-2</div>
              <input
                type="range"
                id="brightness"
                min="-2"
                max="2"
                value="0"
                class="default-action"
              />
              <div class="range-max">2</div>
            </div>
            <div class="input-group" id="contrast-group">
              <label for="contrast">Contrast</label>
              <div class="range-min">-2</div>
              <input
                type="range"
                id="contrast"
                min="-2"
                max="2"
                value="0"
                class="default-action"
              />
              <div class="range-max">2</div>
            </div>
            <div class="input-group" id="saturation-group">
              <label for="saturation">Saturation</label>
              <div class="range-min">-2</div>
              <input
                type="range"
                id="saturation"
                min="-2"
                max="2"
                value="0"
                class="default-action"
              />
              <div class="range-max">2</div>
            </div>
            <div class="input-group" id="aec_value-group">
              <label for="aec_value">Exposure</label>
              <div class="range-min">0</div>
              <input
                type="range"
                id="aec_value"
                min="0"
                max="1200"
                value="204"
                class="default-action"
              />
              <div class="range-max">1200</div>
            </div>
            <section id="buttons">
              <button id="get-still">Get Still</button
              ><button id="toggle-stream">Start Stream</button>
            </section>
          </nav>

          <!-- NASZ KOD // POCZĄTEK -->
          <hr style="width: 100%; border-color: #555" />
          <div style="text-align: center; margin: 5px 0; font-weight: bold">
            Status Akwarium
          </div>

          <div class="input-group">
            <label>Temp. Wody:</label>
            <div class="text"><span id="live-temp">--</span> °C</div>
          </div>
          <div class="input-group">
            <label>Światło:</label>
            <div class="text"><span id="live-light">--</span></div>
          </div>
          <div class="input-group">
            <label>Grzałka:</label>
            <div class="text"><span id="live-heater">--</span></div>
          </div>

          <hr style="width: 100%; border-color: #555" />
          <div style="text-align: center; margin: 5px 0; font-weight: bold">
            Ustawienia Automatyki
          </div>

          <div class="input-group">
            <label for="conf-light-on">Światło ON (Godz):</label>
            <input
              type="number"
              id="conf-light-on"
              min="0"
              max="23"
              class="custom-conf"
            />
          </div>
          <div class="input-group">
            <label for="conf-light-off">Światło OFF (Godz):</label>
            <input
              type="number"
              id="conf-light-off"
              min="0"
              max="23"
              class="custom-conf"
            />
          </div>

          <div class="input-group">
            <label for="conf-heat-min">Grzanie ON (< °C):</label>
            <input
              type="number"
              id="conf-heat-min"
              step="0.1"
              class="custom-conf"
            />
          </div>
          <div class="input-group">
            <label for="conf-heat-max">Grzanie OFF (> °C):</label>
            <input
              type="number"
              id="conf-heat-max"
              step="0.1"
              class="custom-conf"
            />
          </div>

          <button id="btn-save-custom">Zapisz Ustawienia</button>
          <!-- NASZ KOD // KONIEC -->
        </div>
        <figure>
          <div id="stream-container" class="image-container hidden">
            <a
              id="save-still"
              href="#"
              class="button save"
              download="capture.jpg"
              >Save</a
            >
            <div class="close" id="close-stream">×</div>
            <img id="stream" src="" crossorigin />
          </div>
        </figure>
      </div>
    </section>
    <script>
      document.addEventListener("DOMContentLoaded", function (event) {
        var baseHost = document.location.origin;
        var streamUrl = baseHost + ":81";
        function fetchUrl(url, cb) {
          fetch(url)
            .then(function (response) {
              if (response.status !== 200) {
                cb(response.status, response.statusText);
              } else {
                response
                  .text()
                  .then(function (data) {
                    cb(200, data);
                  })
                  .catch(function (err) {
                    cb(-1, err);
                  });
              }
            })
            .catch(function (err) {
              cb(-1, err);
            });
        }
        function setXclk(xclk, cb) {
          fetchUrl(`${baseHost}/xclk?xclk=${xclk}`, cb);
        }
        const setXclkButton = document.getElementById("set-xclk");
        setXclkButton.onclick = () => {
          let xclk = parseInt(document.getElementById("xclk").value);
          setXclk(xclk, function (code, txt) {
            if (code != 200) {
              alert("Error[" + code + "]: " + txt);
            }
          });
        };
        const hide = (el) => {
          el.classList.add("hidden");
        };
        const show = (el) => {
          el.classList.remove("hidden");
        };
        const disable = (el) => {
          el.classList.add("disabled");
          el.disabled = true;
        };
        const enable = (el) => {
          el.classList.remove("disabled");
          el.disabled = false;
        };
        const updateValue = (el, value, updateRemote) => {
          updateRemote = updateRemote == null ? true : updateRemote;
          let initialValue;
          if (el.type === "checkbox") {
            initialValue = el.checked;
            value = !!value;
            el.checked = value;
          } else {
            initialValue = el.value;
            el.value = value;
          }
          if (updateRemote && initialValue !== value) {
            updateConfig(el);
          }
        };
        function updateConfig(el) {
          let value;
          switch (el.type) {
            case "checkbox":
              value = el.checked ? 1 : 0;
              break;
            case "range":
            case "select-one":
              value = el.value;
              break;
            case "button":
            case "submit":
              value = "1";
              break;
            default:
              return;
          }
          const query = `${baseHost}/control?var=${el.id}&val=${value}`;
          fetch(query).then((response) => {
            console.log(
              `request to ${query} finished, status: ${response.status}`
            );
          });
        }
        document.querySelectorAll(".close").forEach((el) => {
          el.onclick = () => {
            hide(el.parentNode);
          };
        });
        fetch(`${baseHost}/status`)
          .then(function (response) {
            return response.json();
          })
          .then(function (state) {
            document.querySelectorAll(".default-action").forEach((el) => {
              updateValue(el, state[el.id], false);
            });
          });
        const view = document.getElementById("stream");
        const viewContainer = document.getElementById("stream-container");
        const stillButton = document.getElementById("get-still");
        const streamButton = document.getElementById("toggle-stream");
        const closeButton = document.getElementById("close-stream");
        const saveButton = document.getElementById("save-still");
        const stopStream = () => {
          window.stop();
          streamButton.innerHTML = "Start Stream";
        };
        const startStream = () => {
          view.src = `${streamUrl}/stream`;
          show(viewContainer);
          streamButton.innerHTML = "Stop Stream";
        };
        stillButton.onclick = () => {
          stopStream();
          view.src = `${baseHost}/capture?_cb=${Date.now()}`;
          show(viewContainer);
        };
        closeButton.onclick = () => {
          stopStream();
          hide(viewContainer);
        };
        streamButton.onclick = () => {
          const streamEnabled = streamButton.innerHTML === "Stop Stream";
          if (streamEnabled) {
            stopStream();
          } else {
            startStream();
          }
        };
        saveButton.onclick = () => {
          var canvas = document.createElement("canvas");
          canvas.width = view.width;
          canvas.height = view.height;
          document.body.appendChild(canvas);
          var context = canvas.getContext("2d");
          context.drawImage(view, 0, 0);
          try {
            var dataURL = canvas.toDataURL("image/jpeg");
            saveButton.href = dataURL;
            var d = new Date();
            saveButton.download =
              d.getFullYear() +
              ("0" + (d.getMonth() + 1)).slice(-2) +
              ("0" + d.getDate()).slice(-2) +
              ("0" + d.getHours()).slice(-2) +
              ("0" + d.getMinutes()).slice(-2) +
              ("0" + d.getSeconds()).slice(-2) +
              ".jpg";
          } catch (e) {
            console.error(e);
          }
          canvas.parentNode.removeChild(canvas);
        };
        document.querySelectorAll(".default-action").forEach((el) => {
          el.onchange = () => updateConfig(el);
        });

        // NEMO CUSTOM JS
        const elTemp = document.getElementById("live-temp");
        const elLight = document.getElementById("live-light");
        const elHeater = document.getElementById("live-heater");

        const inpLightOn = document.getElementById("conf-light-on");
        const inpLightOff = document.getElementById("conf-light-off");
        const inpHeatMin = document.getElementById("conf-heat-min");
        const inpHeatMax = document.getElementById("conf-heat-max");
        const btnSave = document.getElementById("btn-save-custom");

        // Endpoint /status_sensor
        // Posiada dane
        // {                       | Types:
        //   temp: 29.2,           | Number
        //   light_state: true,    | Boolean
        //   heater_state: false,  | Boolean
        //   light_on_h: 8,        | Number (defaultowo np. 9, o której włączy się światło)
        //   light_off_h: 22,      | Number (defaultowo np. 22, o której wyłączy się światło)
        //   heat_min: 24.0,       | Number (defaultowo np. 24.0, o której włączy się grzałka)
        //   heat_max: 25.5,       | Number (defaultowo np. 25.5, o której wyłączy się grzałka)
        // }

        function fetchSensorStatus() {
          fetch(`${baseHost}/status_sensor`)
            .then((response) => response.json())
            .then((data) => {
              elTemp.innerHTML = data.temp.toFixed(1);
              elLight.innerHTML = data.light_state
                ? "<span style='color:#0f0'>WŁ</span>"
                : "<span style='color:#900'>WYŁ</span>";
              elHeater.innerHTML = data.heater_state
                ? "<span style='color:#f00'>WŁ</span>"
                : "<span style='color:#900'>WYŁ</span>";

              // Zabezpieczenia przed pobraniem nie pełnej wartości
              if (document.activeElement !== inpLightOn) {
                inpLightOn.value = data.light_on_h;
              }

              if (document.activeElement !== inpLightOff) {
                inpLightOff.value = data.light_off_h;
              }

              if (document.activeElement !== inpHeatMin) {
                inpHeatMin.value = data.heat_min;
              }

              if (document.activeElement !== inpHeatMax) {
                inpHeatMax.value = data.heat_max;
              }
            })
            .catch((err) => console.error("Błąd pobierania sensorów:", err));
        }

        // Endpoint /save_sensor
        // Params:
        // l_on = Number (o której światło on)
        // l_off = Number (o której światło off)
        // h_min = Number (o której grzałka on)
        // h_max = Number (o której grzałka off)

        btnSave.onclick = () => {
          const query = `${baseHost}/save_sensor?l_on=${inpLightOn.value}&l_off=${inpLightOff.value}&h_min=${inpHeatMin.value}&h_max=${inpHeatMax.value}`;
          fetch(query).then((response) => {
            if (response.status === 200) {
              alert("Ustawienia zapisane!");
            } else {
              alert("Błąd zapisu!");
            }
          });
        };

        fetchSensorStatus();

        // Co 5s aktualizuje informacje
        setInterval(fetchSensorStatus, 5000);
      });
    </script>
  </body>
</html>
