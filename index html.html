<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Projekt Nemo</title>
    <style>
      *,
      *:before,
      *:after {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, Helvetica, sans-serif;
        background: #327686;
        color: #efefef;
        font-size: 16px;
        margin: 0;
        padding: 8px;
      }

      #menu {
        display: none;
      }

      .input-group {
        display: flex;
        flex-wrap: nowrap;
        line-height: 22px;
        margin: 8px 0;
        align-items: center;
      }

      .input-group > label {
        display: inline-block;
        padding-right: 10px;
        min-width: 40%;
      }

      .input-group input,
      .input-group select {
        flex-grow: 1;
      }

      button,
      .button {
        display: block;
        border: 0;
        line-height: 28px;
        cursor: pointer;
        color: #fff;
        background: #ff3034;
        border-radius: 5px;
        font-size: 16px;
        width: 100%;
      }

      button:hover {
        background: #ff494d;
      }

      button:active {
        background: #f21c21;
      }

      input[type="number"] {
        border: 1px solid #363636;
        font-size: 14px;
        height: 30px;
        margin: 1px;
        outline: 0;
        border-radius: 5px;
        padding-left: 5px;
        width: 100%;
        color: #333;
      }

      #content {
        display: flex;
        flex-wrap: nowrap;
        align-items: stretch;
        gap: 10px;
        width: 100%;
      }

      figure {
        padding: 0;
        margin: 0;
        width: 100%;
      }

      figure img {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 4px;
        margin-top: 8px;
      }

      .stream-frame,
      .container {
        background-color: #333;
        padding: 10px;
        border-radius: 10px;
      }

      .stream-frame {
        width: 50%;
        min-height: 100%;
        display: flex;
        gap: 5px;
        flex-direction: column;
        justify-content: end;
      }

      #stream {
        height: auto;
        object-fit: contain;
      }

      .wrapper {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 25%;
      }

      #notification {
        text-align: center;
      }

      .image-container {
        position: relative;
      }

      .btn-group {
        display: flex;
        gap: 5px;
        margin: 10px 0;
      }

      button,
      .button {
        display: block;
        border: 0;
        line-height: 28px;
        cursor: pointer;
        color: #fff;
        background: #ff3034;
        border-radius: 5px;
        font-size: 16px;
        width: 100%;
      }

      .light-btn {
        font-size: 13px;
        padding: 0 5px;
        background: #e67e22;
      }

      .auto-btn {
        font-size: 13px;
        background: #27ae60;
      }

      #block-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        z-index: 9999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        text-align: center;
      }

      .block-overlay-text {
        font-size: 32px;
        color: red;
      }

      @media (max-width: 1200px) {
        .wrapper {
          width: 50%;
        }
      }

      @media (max-width: 800px) {
        .stream-frame {
          width: 100%;
          min-height: 500px;
        }

        #content {
          flex-direction: column;
        }

        .wrapper {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="block-overlay">
      <div class="block-overlay-text">Trwa pomiar poziomu wody...</div>
      <div>Brak połączenia z serwerem</div>
    </div>
    <section class="main">
      <div id="content">
        <!-- Ukryte menu -->
        <nav id="menu">
          <section id="xclk-section">
            <div class="input-group" id="set-xclk-group">
              <label for="set-xclk">XCLK MHz</label>
              <div class="text">
                <input
                  id="xclk"
                  type="text"
                  minlength="1"
                  maxlength="2"
                  size="2"
                  value="19"
                  disabled
                />
              </div>
              <button class="inline-button" id="set-xclk" disabled>Set</button>
            </div>
          </section>
          <div class="input-group" id="framesize-group">
            <label for="framesize">Resolution</label
            ><select id="framesize" class="default-action" disabled>
              <option value="13">UXGA(1600x1200)</option>
              <option value="12">SXGA(1280x1024)</option>
              <option value="11">HD(1280x720)</option>
              <option value="10">XGA(1024x768)</option>
              <option value="9" selected>SVGA(800x600)</option>
              <!--main selection ^ -->
              <option value="8">VGA(640x480)</option>
              <option value="7">HVGA(480x320)</option>
              <option value="6">CIF(400x296)</option>
              <option value="5">QVGA(320x240)</option>
              <option value="4">240x240</option>
              <option value="3">HQVGA(240x176)</option>
              <option value="2">QCIF(176x144)</option>
              <option value="1">QQVGA(160x120)</option>
              <option value="0">96x96</option>
            </select>
          </div>
          <div class="input-group" id="quality-group">
            <label for="quality">Quality</label>
            <div class="range-min">4</div>
            <input
              type="range"
              id="quality"
              min="4"
              max="63"
              value="10"
              class="default-action"
              disabled
            />
            <div class="range-max">63</div>
          </div>
          <div class="input-group" id="brightness-group">
            <label for="brightness">Brightness</label>
            <div class="range-min">-2</div>
            <input
              type="range"
              id="brightness"
              min="-2"
              max="2"
              value="0"
              class="default-action"
              disabled
            />
            <div class="range-max">2</div>
          </div>
          <div class="input-group" id="contrast-group">
            <label for="contrast">Contrast</label>
            <div class="range-min">-2</div>
            <input
              type="range"
              id="contrast"
              min="-2"
              max="2"
              value="0"
              class="default-action"
              disabled
            />
            <div class="range-max">2</div>
          </div>
          <div class="input-group" id="saturation-group">
            <label for="saturation">Saturation</label>
            <div class="range-min">-2</div>
            <input
              type="range"
              id="saturation"
              min="-2"
              max="2"
              value="0"
              class="default-action"
              disabled
            />
            <div class="range-max">2</div>
          </div>
          <div class="input-group" id="aec_value-group">
            <label for="aec_value">Exposure</label>
            <div class="range-min">0</div>
            <input
              type="range"
              id="aec_value"
              min="0"
              max="1200"
              value="204"
              class="default-action"
              disabled
            />
            <div class="range-max">1200</div>
          </div>
        </nav>

        <div class="stream-frame">
          <figure>
            <div id="stream-container" class="image-container">
              <p id="notification">Podgląd kamery jest wyłączony!</p>
              <img id="stream" src="" crossorigin />
            </div>
          </figure>
          <!-- Przycisk start -->
          <button id="toggle-stream">Start Stream</button>
        </div>

        <!-- NASZ KOD // POCZĄTEK -->
        <div class="wrapper">
          <div class="container">
            <div style="text-align: center; margin: 5px 0; font-weight: bold">
              Status Akwarium
            </div>

            <div class="input-group">
              <label>Temp. Wody:</label>
              <div class="text"><span id="live-temp">--</span> °C</div>
            </div>
            <div class="input-group">
              <label>Światło:</label>
              <div class="text"><span id="live-light">--</span></div>
            </div>
            <div class="input-group">
              <label>Grzałka:</label>
              <div class="text"><span id="live-heater">--</span></div>
            </div>
          </div>

          <div class="container">
            <div style="text-align: center; margin: 5px 0; font-weight: bold">
              Ustawienia Automatyki
            </div>
            <p style="margin: 20px 0px 0px 10px; font-weight: bold">
              Pomiar poziomu wody
            </p>
            <div class="btn-group">
              <button class="auto-btn" id="check_water_lvl" />
              <span id="check_water_lvl_box">Kliknij</span>
            </div>
            <p style="margin: 20px 0px 0px 10px; font-weight: bold">
              Tryb Światła
            </p>
            <div class="btn-group">
              <button id="btn-morning" class="light-btn">Rano</button>
              <button id="btn-evening" class="light-btn">Wieczór</button>
              <button id="btn-night" class="light-btn">Noc</button>
              <button id="btn-auto" class="auto-btn">Auto</button>
            </div>
            <div class="input-group">
              <label for="conf-light-on">Światło ON (Godz):</label>
              <input
                type="number"
                id="conf-light-on"
                min="0"
                max="23"
                class="custom-conf"
              />
            </div>
            <div class="input-group">
              <label for="conf-light-off">Światło OFF (Godz):</label>
              <input
                type="number"
                id="conf-light-off"
                min="0"
                max="23"
                class="custom-conf"
              />
            </div>

            <div class="input-group">
              <label for="conf-heat-min">Grzanie ON (< °C):</label>
              <input
                type="number"
                id="conf-heat-min"
                step="0.1"
                class="custom-conf"
              />
            </div>
            <div class="input-group">
              <label for="conf-heat-max">Grzanie OFF (> °C):</label>
              <input
                type="number"
                id="conf-heat-max"
                step="0.1"
                class="custom-conf"
              />
            </div>
            <button id="btn-save-custom">Zapisz Ustawienia</button>
          </div>
        </div>
        <!-- NASZ KOD // KONIEC -->
      </div>
    </section>
    <script>
      document.addEventListener("DOMContentLoaded", function (event) {
        var baseHost = document.location.origin;
        var streamUrl = baseHost + ":81";

        function fetchUrl(url, cb) {
          fetch(url)
            .then(function (response) {
              if (response.status !== 200) {
                cb(response.status, response.statusText);
              } else {
                response
                  .text()
                  .then(function (data) {
                    cb(200, data);
                  })
                  .catch(function (err) {
                    cb(-1, err);
                  });
              }
            })
            .catch(function (err) {
              cb(-1, err);
            });
        }

        const disable = (el) => {
          el.classList.add("disabled");
          el.disabled = true;
        };
        const enable = (el) => {
          el.classList.remove("disabled");
          el.disabled = false;
        };

        const updateValue = (el, value, updateRemote) => {
          updateRemote = updateRemote == null ? true : updateRemote;
          let initialValue;
          if (el.type === "checkbox") {
            initialValue = el.checked;
            value = !!value;
            el.checked = value;
          } else {
            initialValue = el.value;
            el.value = value;
          }
          if (updateRemote && initialValue !== value) {
            updateConfig(el);
          }
        };

        function updateConfig(el) {
          let value;
          switch (el.type) {
            case "checkbox":
              value = el.checked ? 1 : 0;
              break;
            case "range":
            case "select-one":
              value = el.value;
              break;
            case "button":
            case "submit":
              value = "1";
              break;
            default:
              return;
          }
          const query = `${baseHost}/control?var=${el.id}&val=${value}`;
          fetch(query).then((response) => {
            console.log(
              `request to ${query} finished, status: ${response.status}`,
            );
          });
        }

        fetch(`${baseHost}/status`)
          .then(function (response) {
            return response.json();
          })
          .then(function (state) {
            document.querySelectorAll(".default-action").forEach((el) => {
              updateValue(el, state[el.id], false);
            });
          });
        const view = document.getElementById("stream");
        const viewContainer = document.getElementById("stream-container");
        const streamButton = document.getElementById("toggle-stream");

        const notification = document.getElementById("notification");

        const stopStream = () => {
          window.stop();
          notification.style.display = "block";
          streamButton.innerHTML = "Start Stream";
        };
        const startStream = () => {
          view.src = `${streamUrl}/stream`;
          notification.style.display = "none";
          streamButton.innerHTML = "Stop Stream";
        };

        streamButton.onclick = () => {
          const streamEnabled = streamButton.innerHTML === "Stop Stream";
          if (streamEnabled) {
            stopStream();
          } else {
            startStream();
          }
        };

        document.querySelectorAll(".default-action").forEach((el) => {
          el.onchange = () => updateConfig(el);
        });

        // NEMO CUSTOM JS
        const btnMorning = document.getElementById("btn-morning");
        const btnNight = document.getElementById("btn-night");
        const btnEvening = document.getElementById("btn-evening");
        const btnAuto = document.getElementById("btn-auto");

        const elTemp = document.getElementById("live-temp");
        const elLight = document.getElementById("live-light");
        const elHeater = document.getElementById("live-heater");

        const inpLightOn = document.getElementById("conf-light-on");
        const inpLightOff = document.getElementById("conf-light-off");
        const inpHeatMin = document.getElementById("conf-heat-min");
        const inpHeatMax = document.getElementById("conf-heat-max");
        const btnSave = document.getElementById("btn-save-custom");

        const checkWaterLvl = document.getElementById("check_water_lvl");
        const checkWaterLvlBox = document.getElementById("check_water_lvl_box");

        // Endpoint /set_light_mode?mode=param
        // {
        //  param: morning | evening | night |  auto <- String Types
        // }

        const setLightMode = (mode) => {
          fetch(`${baseHost}/set_light_mode?mode=${mode}`)
            .then((response) => {
              if (response.ok) {
                alert("Zmieniono tryb na: " + mode);
              } else {
                console.error("Błąd ustawiania trybu światła");
              }
            })
            .catch((err) => console.error(err));
        };

        btnMorning.onclick = () => setLightMode("morning");
        btnNight.onclick = () => setLightMode("night");
        btnEvening.onclick = () => setLightMode("evening");
        btnAuto.onclick = () => setLightMode("auto");

        // Endpoint /check_water_lvl
        // Posiada dane
        // {                       | Types:
        //   water_level: 29,    | Number/String
        // }

        checkWaterLvl.addEventListener("click", async () => {
          checkWaterLvlBox.innerHTML = "Ładowanie...";

          try {
            const response = await fetch(`${baseHost}/check_water_lvl`);

            if (!response.ok) {
              throw new Error(`Błąd serwera: ${response.status}`);
            }

            const data = await response.json();
            checkWaterLvlBox.innerHTML = `${data.water_level.toFixed(0)}%`;
          } catch (error) {
            console.error(error);
            checkWaterLvlBox.innerHTML = "Błąd";
          }
        });

        // Endpoint /status_sensor
        // Posiada dane
        // {                       | Types:
        //   temp: 29.2,           | Number
        //   light_state: true,    | Boolean
        //   heater_state: false,  | Boolean
        //   light_on_h: 8,        | Number (defaultowo np. 9, o której włączy się światło)
        //   light_off_h: 22,      | Number (defaultowo np. 22, o której wyłączy się światło)
        //   heat_min: 24.0,       | Number (defaultowo np. 24.0, o której włączy się grzałka)
        //   heat_max: 25.5,       | Number (defaultowo np. 25.5, o której wyłączy się grzałka)
        // }

        let isEditing = false;

        const inputs = [inpLightOn, inpLightOff, inpHeatMin, inpHeatMax];

        inputs.forEach((input) => {
          input.addEventListener("focus", () => {
            isEditing = true;
          });
          input.addEventListener("blur", () => {
            isEditing = false;
          });
        });

        function fetchSensorStatus() {
          const overlay = document.getElementById("block-overlay");

          fetch(`${baseHost}/status_sensor`)
            .then((response) => {
              if (!response.ok) throw new Error("Błąd sieci!!!!");
              return response.json();
            })
            .then((data) => {
              overlay.style.display = "none";

              elTemp.innerHTML = data.temp.toFixed(1);
              elLight.innerHTML = data.light_state
                ? "<span style='color:#0f0'>WŁ</span>"
                : "<span style='color:#900'>WYŁ</span>";
              elHeater.innerHTML = data.heater_state
                ? "<span style='color:#0f0'>WŁ</span>"
                : "<span style='color:#900'>WYŁ</span>";

              if (!isEditing) {
                inpLightOn.value = data.light_on_h;
                inpLightOff.value = data.light_off_h;
                inpHeatMin.value = data.heat_min;
                inpHeatMax.value = data.heat_max;
              }
            })
            .catch((err) => {
              console.error("Błąd pobierania sensorów:", err);
              overlay.style.display = "flex";
            });
        }

        // Endpoint /save_sensor
        // Params:
        // l_on = Number (o której światło on)
        // l_off = Number (o której światło off)
        // h_min = Number (o której grzałka on)
        // h_max = Number (o której grzałka off)

        btnSave.onclick = () => {
          const query = `${baseHost}/save_sensor?l_on=${inpLightOn.value}&l_off=${inpLightOff.value}&h_min=${inpHeatMin.value}&h_max=${inpHeatMax.value}`;
          fetch(query)
            .then((response) => {
              if (response.status === 200) {
                alert("Ustawienia zapisane!");
              } else {
                alert("Błąd zapisu!");
              }
            })
            .finally(() => {
              fetchSensorStatus();
            });
        };

        fetchSensorStatus();

        // Co 1s aktualizuje informacje
        setInterval(fetchSensorStatus, 1000);
      });
    </script>
  </body>
</html>
